<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0b0b" />
  <title>Flight Display</title>
  
  <!-- Cache busting -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <style>
    :root{
      color-scheme: light dark;
      --ink: CanvasText;
      --bg: Canvas;
      --elev: color-mix(in oklab, Canvas 94%, Canvas);
      --hair: color-mix(in oklab, CanvasText 18%, transparent);
      --muted: color-mix(in oklab, CanvasText 35%, transparent);
      --ok: #14b45c;
      --warn: #f7be00;
      --err: #ff453a;
      --ok-soft: color-mix(in oklab, var(--ok) 18%, transparent);
      --surface: color-mix(in oklab, Canvas 96%, Canvas);
    }
    *{box-sizing:border-box}
    html{font-family:-apple-system,BlinkMacSystemFont,system-ui,"Segoe UI",Roboto,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--ink)}

    .screen{min-height:100svh;display:flex;flex-direction:column}

    /* Header */
    .hdr{position:sticky;top:0;backdrop-filter:saturate(180%) blur(20px);
         background:color-mix(in oklab, Canvas 80%, transparent);
         border-bottom:0.5px solid var(--hair)}
    .hdr-in{padding: env(safe-area-inset-top) 16px 10px;display:flex;align-items:center;gap:10px}
    .airline-mark{display:grid;place-items:center;width:28px;height:28px;border-radius:7px;overflow:hidden;
                  background:color-mix(in oklab, CanvasText 8%, transparent)}
    .airline-mark img{width:100%;height:100%;object-fit:cover}
    .route-title{font-weight:800;font-size:22px;line-height:1.15}
    .route-sub{font-size:13px;opacity:.75}

    /* Status banner */
    .status{background:color-mix(in oklab, var(--ok) 25%, transparent);
            border-bottom:0.5px solid color-mix(in oklab, var(--ok) 60%, transparent)}
    .status.warn{background:color-mix(in oklab, var(--warn) 24%, transparent);
                 border-bottom-color:color-mix(in oklab, var(--warn) 60%, transparent)}
    .status.err{background:color-mix(in oklab, var(--err) 20%, transparent);
                border-bottom-color:color-mix(in oklab, var(--err) 60%, transparent)}
    .status-in{padding:12px 16px}
    .status-big{font-weight:800;font-size:18px;color:var(--ok)}
    .status.warn .status-big{color:#926a00}
    .status.err .status-big{color:#ff453a}
    .status-sub{font-size:13px;opacity:.9}

    /* Content */
    .main{padding:16px;max-width:860px;margin:0 auto;flex:1}

    .display-card{border-radius:20px;background:var(--surface);border:1px solid var(--hair);
                  overflow:hidden;box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .block{padding:16px}

    /* Grid for departure / arrival */
    .grid{display:grid;grid-template-columns:1fr 46px 1fr;gap:10px;align-items:start}

    .airport{display:flex;flex-direction:column;gap:6px}
    .iata{font-weight:900;font-size:44px;letter-spacing:.5px}
    .time-row{display:flex;align-items:baseline;gap:10px}
    .time-actual{font-weight:800;font-size:32px;color:var(--ok)}
    .time-date{font-size:14px;color:var(--muted);margin-top:4px}
    .meta{font-size:14px;color:var(--muted)}
    .meta b{color:var(--ink)}

    /* Vertical progress rail */
    .rail{display:flex;flex-direction:column;align-items:center;margin-top:6px}
    .rail-line{position:relative;width:8px;border-radius:8px;
               background:linear-gradient(to bottom, var(--ok-soft), color-mix(in oklab, var(--ok) 32%, transparent));
               height:100%}
    .rail-cap{width:12px;height:12px;border-radius:50%;background:var(--ok);
              box-shadow:0 0 0 2px color-mix(in oklab, var(--ok) 30%, transparent)}
    .plane{position:absolute;left:50%;transform:translate(-50%,-50%);font-size:18px;filter:saturate(1.2)}

    .divider{height:1px;background:var(--hair);margin:10px 0}

    /* Footer meta */
    .footer{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;color:var(--muted);
            font-size:13px;padding:12px 16px}
    .footer .dot{width:4px;height:4px;border-radius:50%;background:currentColor;align-self:center}

    @media (max-width:480px){
      .iata{font-size:40px}
      .time-actual{font-size:28px}
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--muted);
    }

    .error {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--err);
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="screen">
    <!-- Header -->
    <header class="hdr">
      <div class="hdr-in safe">
        <div class="airline-mark" aria-hidden="true">
          <img id="airlineLogo" alt="Airline" style="display: none;">
        </div>
        <div>
          <div class="route-title" id="routeTitle">Loading...</div>
          <div class="route-sub" id="routeSub">Loading...</div>
        </div>
      </div>
    </header>

    <!-- Status Banner -->
    <section class="status" id="status">
      <div class="status-in safe">
        <div class="status-big" id="statusBig">Loading...</div>
        <div class="status-sub" id="statusSub">Please wait</div>
      </div>
    </section>

    <!-- Main Card -->
    <main class="main">
      <div class="display-card" role="group" aria-label="Flight display">
        <div class="block">
          <div class="grid">
            <!-- Departure -->
            <section class="airport" aria-label="Departure">
              <div class="iata" id="depCode">---</div>
              <div class="time-row">
                <div class="time-actual" id="depActual">--:--</div>
                <div class="time-date" id="depDate">Loading...</div>
              </div>
              <div class="meta" id="depMeta">Loading...</div>
            </section>

            <!-- Rail -->
            <div class="rail" aria-hidden="true">
              <div class="rail-cap"></div>
              <div class="rail-line" id="railLine" style="height:180px">
                <div class="plane" id="plane">✈️</div>
              </div>
              <div class="rail-cap"></div>
            </div>

            <!-- Arrival -->
            <section class="airport" aria-label="Arrival">
              <div class="iata" id="arrCode">---</div>
              <div class="time-row">
                <div class="time-actual" id="arrActual">--:--</div>
                <div class="time-date" id="arrDate">Loading...</div>
              </div>
              <div class="meta" id="arrMeta">Loading...</div>
            </section>
          </div>

          <div class="divider"></div>

          <footer class="footer">
            <div>Total <span id="totalDur">Loading...</span></div>
            <div class="dot"></div>
            <div>Confirmation <span id="confirmation">Loading...</span></div>
          </footer>
        </div>
      </div>
    </main>
  </div>

  <script>
    const qsid = (id)=>document.getElementById(id);

    // Format time and date
    const fmtTime = (d)=> new Intl.DateTimeFormat(undefined,{hour:'numeric',minute:'2-digit'}).format(d);
    const fmtDate = (d)=> new Intl.DateTimeFormat(undefined,{weekday:'short', month:'short', day:'numeric'}).format(d);

    // Get flight ID from URL path
    function getFlightIdFromPath() {
      const path = window.location.pathname;
      const match = path.match(/\/flight\/(.+)$/);
      return match ? match[1] : null;
    }

    // Calculate time until departure
    function getTimeUntilDeparture(departureTime) {
      const now = new Date();
      const dep = new Date(departureTime);
      const diff = dep - now;
      
      if (diff <= 0) {
        return { text: 'Flight Departed', isPast: true };
      }
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      if (days > 0) {
        return { text: `${days}d ${hours}h ${minutes}m`, isPast: false };
      } else if (hours > 0) {
        return { text: `${hours}h ${minutes}m`, isPast: false };
      } else {
        return { text: `${minutes}m`, isPast: false };
      }
    }

    // Calculate flight duration
    function getFlightDuration(departureTime, arrivalTime) {
      const dep = new Date(departureTime);
      const arr = new Date(arrivalTime);
      const diff = arr - dep;
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      return `${hours}h ${minutes}m`;
    }

    // Load flight data
    async function loadFlightData() {
      const flightId = getFlightIdFromPath();
      
      if (!flightId) {
        showError('Invalid flight URL');
        return;
      }

      try {
        const response = await fetch(`/api/flight/${flightId}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            showError('Flight not found');
          } else {
            showError('Failed to load flight data');
          }
          return;
        }

        const flightData = await response.json();
        displayFlightData(flightData);
        
      } catch (error) {
        console.error('Error loading flight data:', error);
        showError('Failed to load flight data');
      }
    }

    // Display flight data
    function displayFlightData(data) {
      // Parse departure time range
      const [departureTime, arrivalTime] = data.departureTime.split('/');
      const depDate = new Date(departureTime);
      const arrDate = new Date(arrivalTime);
      
      // Update header
      qsid('routeTitle').textContent = data.route;
      qsid('routeSub').textContent = `${fmtDate(depDate)} • ${data.flightNumber} • ${data.airline}`;
      
      // Update airport codes and times
      qsid('depCode').textContent = data.departureCode;
      qsid('arrCode').textContent = data.arrivalCode;
      
      qsid('depActual').textContent = fmtTime(depDate);
      qsid('arrActual').textContent = fmtTime(arrDate);
      
      qsid('depDate').textContent = fmtDate(depDate);
      qsid('arrDate').textContent = fmtDate(arrDate);
      
      // Update meta info
      qsid('depMeta').innerHTML = `<b>Departure</b><br>${data.departureName}`;
      qsid('arrMeta').innerHTML = `<b>Arrival</b><br>${data.arrivalName}`;
      
      // Update footer
      qsid('totalDur').textContent = getFlightDuration(departureTime, arrivalTime);
      qsid('confirmation').textContent = data.confirmation;
      
      // Update status and progress
      updateStatusAndProgress(departureTime, arrivalTime);
    }

    // Update status banner and progress
    function updateStatusAndProgress(departureTime, arrivalTime) {
      const status = qsid('status');
      const statusBig = qsid('statusBig');
      const statusSub = qsid('statusSub');
      const plane = qsid('plane');
      const railLine = qsid('railLine');
      
      const now = new Date();
      const depDate = new Date(departureTime);
      const arrDate = new Date(arrivalTime);
      
      function fmtDur(ms) {
        const s = Math.max(0, Math.round(ms/1000));
        const h = s/3600|0; 
        const m = (s%3600)/60|0; 
        return `${h}h ${String(m).padStart(2,'0')}m`;
      }
      
      function tick() {
        const now = new Date();
        
        if (now < depDate) {
          // Before departure
          status.className = 'status warn';
          statusBig.textContent = `Departs in ${fmtDur(depDate-now)}`;
          statusSub.textContent = 'Boarding soon';
          plane.style.top = '0px';
        } else if (now >= depDate && now <= arrDate) {
          // In flight
          status.className = 'status';
          statusBig.textContent = `Lands in ${fmtDur(arrDate-now)}`;
          statusSub.textContent = 'Flight is En Route';
          
          // Update plane position
          const t = (now - depDate) / (arrDate - depDate);
          const clamped = Math.max(0, Math.min(1, t));
          const h = railLine.getBoundingClientRect().height;
          plane.style.top = `${clamped * h}px`;
        } else {
          // After arrival
          status.className = 'status';
          statusBig.textContent = 'Landed';
          statusSub.textContent = `Arrived ${fmtDur(now-arrDate)} ago`;
          plane.style.top = '100%';
        }
      }
      
      setInterval(tick, 1000);
      tick();
    }

    // Show error message
    function showError(message) {
      const screen = document.querySelector('.screen');
      screen.innerHTML = `
        <div class="error">
          <div>
            <h3>Error</h3>
            <p>${message}</p>
            <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: var(--ok); color: white; border: none; border-radius: 4px; cursor: pointer;">
              Retry
            </button>
          </div>
        </div>
      `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadFlightData);
  </script>
</body>
</html>