<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <title>Flight Display</title>
  
  <!-- Cache busting -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <style>
    :root{
      color-scheme: dark;
      --ink: #ffffff;
      --bg: #000000;
      --elev: #1a1a1a;
      --hair: #333333;
      --muted: #999999;
      --ok: #14b45c;
      --warn: #f7be00;
      --err: #ff453a;
      --ok-soft: color-mix(in oklab, var(--ok) 18%, transparent);
      --surface: #1a1a1a;
    }
    *{box-sizing:border-box}
    html{font-family:-apple-system,BlinkMacSystemFont,system-ui,"Segoe UI",Roboto,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--ink)}

    .screen{min-height:100svh;display:flex;flex-direction:column}


    /* Status banner */
    .status{background:rgba(20, 180, 92, 0.15);
            border-bottom:0.5px solid rgba(20, 180, 92, 0.3);
            width:100%;padding:0 16px}
    .status.warn{background:rgba(247, 190, 0, 0.15);
                 border-bottom-color:rgba(247, 190, 0, 0.3)}
    .status.err{background:rgba(255, 69, 58, 0.15);
                border-bottom-color:rgba(255, 69, 58, 0.3)}
    .status-in{padding:12px 0}
    .status-big{font-weight:800;font-size:18px;color:var(--ok)}
    .status.warn .status-big{color:#926a00}
    .status.err .status-big{color:#ff453a}
    .status-sub{font-size:13px;opacity:.9}

    /* Content */
    .main{padding:16px;max-width:860px;margin:0 auto;flex:1}

    .display-card{border-radius:20px;background:var(--surface);border:1px solid var(--hair);
                  overflow:hidden;box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .block{padding:16px}

    /* Grid for departure / arrival */
    .grid{display:grid;grid-template-columns:1fr 46px 1fr;gap:10px;align-items:start}

    .airport{display:flex;flex-direction:column;gap:6px}
    .iata{font-weight:900;font-size:44px;letter-spacing:.5px}
    .time-row{display:flex;align-items:baseline;gap:10px}
    .time-actual{font-weight:800;font-size:32px;color:var(--ok)}
    .time-date{font-size:14px;color:var(--muted);margin-top:4px}
    .meta{font-size:14px;color:var(--muted)}
    .meta b{color:var(--ink)}

    /* Vertical progress rail */
    .rail{display:flex;flex-direction:column;align-items:center;margin-top:6px}
    .rail-line{position:relative;width:8px;border-radius:8px;
               background:linear-gradient(to bottom, rgba(20, 180, 92, 0.2), rgba(20, 180, 92, 0.4));
               height:100%}
    .rail-cap{width:12px;height:12px;border-radius:50%;background:var(--ok);
              box-shadow:0 0 0 2px rgba(20, 180, 92, 0.3)}
    .plane{position:absolute;left:50%;transform:translate(-50%,-50%);font-size:18px;filter:saturate(1.2)}

    .divider{height:1px;background:var(--hair);margin:10px 0}

    /* Footer meta */
    .footer{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;color:var(--muted);
            font-size:13px;padding:12px 16px}
    .footer .dot{width:4px;height:4px;border-radius:50%;background:currentColor;align-self:center}

    @media (max-width:480px){
      .iata{font-size:40px}
      .time-actual{font-size:28px}
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--muted);
    }

    .error {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--err);
      text-align: center;
      padding: 20px;
    }

    /* Real-time status styles */
    .status-info {
      background: var(--surface);
      border: 1px solid var(--hair);
      border-radius: 12px;
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
    }

    .status-label {
      color: var(--muted);
      font-weight: 500;
    }

    .status-value {
      color: var(--ink);
      font-weight: 600;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.on-time {
      background: var(--ok-soft);
      color: var(--ok);
    }

    .status-badge.delayed {
      background: rgba(247, 190, 0, 0.15);
      color: var(--warn);
    }

    .status-badge.cancelled {
      background: rgba(255, 69, 58, 0.15);
      color: var(--err);
    }

    .status-badge.unknown {
      background: rgba(153, 153, 153, 0.15);
      color: var(--muted);
    }

    .refresh-button {
      background: var(--ok);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .refresh-button:hover {
      background: color-mix(in oklab, var(--ok) 80%, black);
    }

    .refresh-button:disabled {
      background: var(--muted);
      cursor: not-allowed;
    }

    .last-updated {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .gate-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .gate-icon {
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="screen">
    <!-- Status Banner -->
    <section class="status" id="status">
      <div class="status-in safe">
        <div class="status-big" id="statusBig">Loading...</div>
        <div class="status-sub" id="statusSub">Please wait</div>
      </div>
    </section>

    <!-- Main Card -->
    <main class="main">
      <div class="display-card" role="group" aria-label="Flight display">
        <div class="block">
          <div class="grid">
            <!-- Departure -->
            <section class="airport" aria-label="Departure">
              <div class="iata" id="depCode">---</div>
              <div class="time-row">
                <div class="time-actual" id="depActual">--:--</div>
                <div class="time-date" id="depDate">Loading...</div>
              </div>
              <div class="meta" id="depMeta">Loading...</div>
            </section>

            <!-- Rail -->
            <div class="rail" aria-hidden="true">
              <div class="rail-cap"></div>
              <div class="rail-line" id="railLine" style="height:180px">
                <div class="plane" id="plane">‚úàÔ∏è</div>
              </div>
              <div class="rail-cap"></div>
            </div>

            <!-- Arrival -->
            <section class="airport" aria-label="Arrival">
              <div class="iata" id="arrCode">---</div>
              <div class="time-row">
                <div class="time-actual" id="arrActual">--:--</div>
                <div class="time-date" id="arrDate">Loading...</div>
              </div>
              <div class="meta" id="arrMeta">Loading...</div>
            </section>
          </div>

          <div class="divider"></div>

          <!-- Real-time Status Section -->
          <div class="status-info" id="statusInfo" style="display: none;">
            <div class="status-row">
              <span class="status-label">Status</span>
              <span class="status-badge" id="statusBadge">Loading...</span>
            </div>
            
            <div class="status-row" id="departureGateRow" style="display: none;">
              <span class="status-label">Departure Gate</span>
              <div class="gate-info">
                <span class="gate-icon">üö™</span>
                <span class="status-value" id="departureGate">--</span>
                <span class="status-value" id="departureTerminal">--</span>
              </div>
            </div>
            
            <div class="status-row" id="arrivalGateRow" style="display: none;">
              <span class="status-label">Arrival Gate</span>
              <div class="gate-info">
                <span class="gate-icon">üö™</span>
                <span class="status-value" id="arrivalGate">--</span>
                <span class="status-value" id="arrivalTerminal">--</span>
              </div>
            </div>
            
            <div class="status-row" id="baggageRow" style="display: none;">
              <span class="status-label">Baggage Claim</span>
              <div class="gate-info">
                <span class="gate-icon">üß≥</span>
                <span class="status-value" id="baggageClaim">--</span>
              </div>
            </div>
            
            <div class="status-row" id="delayRow" style="display: none;">
              <span class="status-label">Delay</span>
              <span class="status-value" id="delayInfo">--</span>
            </div>
            
            <div style="margin-top: 12px; text-align: center;">
              <button class="refresh-button" id="refreshButton" onclick="refreshFlightStatus()">
                üîÑ Refresh Status
              </button>
            </div>
            
            <div class="last-updated" id="lastUpdated">
              Last updated: Loading...
            </div>
          </div>

          <footer class="footer">
            <div>Total <span id="totalDur">Loading...</span></div>
            <div class="dot"></div>
            <div>Confirmation <span id="confirmation">Loading...</span></div>
          </footer>
        </div>
      </div>
    </main>
  </div>

  <script>
    const qsid = (id)=>document.getElementById(id);

    // Format time and date - times are already in correct local format
    const fmtTime = (d) => {
      const hours = d.getHours();
      const minutes = d.getMinutes().toString().padStart(2, '0');
      
      // Convert to 12-hour format
      let displayHours = hours;
      let period = 'AM';
      
      if (hours === 0) {
        displayHours = 12;
      } else if (hours === 12) {
        period = 'PM';
      } else if (hours > 12) {
        displayHours = hours - 12;
        period = 'PM';
      }
      
      return `${displayHours}:${minutes} ${period}`;
    };
    
    const fmtDate = (d) => {
      return new Intl.DateTimeFormat(undefined, {weekday:'short', month:'short', day:'numeric'}).format(d);
    };

    // Get flight data from URL parameters
    function getFlightDataFromParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        flightNumber: params.get('flight') || 'N/A',
        departureTime: params.get('departure') || '',
        airline: params.get('airline') || 'N/A',
        route: params.get('route') || 'N/A',
        confirmation: params.get('confirmation') || 'N/A',
        departureCode: params.get('departureCode') || 'N/A',
        arrivalCode: params.get('arrivalCode') || 'N/A',
        departureName: params.get('departureName') || 'N/A',
        arrivalName: params.get('arrivalName') || 'N/A'
      };
    }

    // Calculate time until departure
    function getTimeUntilDeparture(departureTime) {
      const now = new Date();
      const dep = new Date(departureTime);
      const diff = dep - now;
      
      if (diff <= 0) {
        return { text: 'Flight Departed', isPast: true };
      }
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      if (days > 0) {
        return { text: `${days}d ${hours}h ${minutes}m`, isPast: false };
      } else if (hours > 0) {
        return { text: `${hours}h ${minutes}m`, isPast: false };
      } else {
        return { text: `${minutes}m`, isPast: false };
      }
    }

    // Calculate flight duration
    function getFlightDuration(departureTime, arrivalTime) {
      const dep = new Date(departureTime);
      const arr = new Date(arrivalTime);
      const diff = arr - dep;
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      return `${hours}h ${minutes}m`;
    }

    // Load flight data
    function loadFlightData() {
      const flightData = getFlightDataFromParams();
      
      if (!flightData.departureTime) {
        showError('Invalid flight URL - missing departure time');
        return;
      }

      displayFlightData(flightData);
      
      // Load real-time status
      loadFlightStatus();
    }

    // Load real-time flight status from FlightAware
    async function loadFlightStatus() {
      try {
        // Try to get flightId from URL path first (new format)
        let flightId = window.location.pathname.split('/')[2]; // e.g., "pageId-departure"
        
        // If not found, try to construct from URL parameters (current format)
        if (!flightId) {
          const params = new URLSearchParams(window.location.search);
          const flight = params.get('flight');
          const airline = params.get('airline');
          
          if (flight && airline) {
            // For now, use 'test' as flightId since we don't have the actual Notion page ID
            // In production, you'd need to pass the actual Notion page ID
            flightId = 'test';
            console.log('Using test flightId for FlightAware API');
          } else {
            console.log('No flight ID found in URL path or parameters');
            return;
          }
        }

        const response = await fetch(`/api/flight/${flightId}/status`);
        const statusData = await response.json();
        
        displayFlightStatus(statusData);
      } catch (error) {
        console.error('Error loading flight status:', error);
        // Don't show error to user - just log it and continue with Notion data
      }
    }

    // Display real-time flight status
    function displayFlightStatus(statusData) {
      const statusInfo = qsid('statusInfo');
      const statusBadge = qsid('statusBadge');
      const lastUpdated = qsid('lastUpdated');
      
      // Show the status section
      statusInfo.style.display = 'block';
      
      // Update status badge
      const status = statusData.status || 'Unknown';
      statusBadge.textContent = status;
      statusBadge.className = 'status-badge';
      
      // Add appropriate class based on status
      if (status.toLowerCase().includes('on time') || status.toLowerCase().includes('scheduled')) {
        statusBadge.classList.add('on-time');
      } else if (status.toLowerCase().includes('delayed')) {
        statusBadge.classList.add('delayed');
      } else if (status.toLowerCase().includes('cancelled')) {
        statusBadge.classList.add('cancelled');
      } else {
        statusBadge.classList.add('unknown');
      }
      
      // Show departure gate info
      if (statusData.departureGate || statusData.departureTerminal) {
        const departureGateRow = qsid('departureGateRow');
        const departureGate = qsid('departureGate');
        const departureTerminal = qsid('departureTerminal');
        
        departureGateRow.style.display = 'flex';
        departureGate.textContent = statusData.departureGate || 'TBD';
        departureTerminal.textContent = statusData.departureTerminal ? `(${statusData.departureTerminal})` : '';
      }
      
      // Show arrival gate info
      if (statusData.arrivalGate || statusData.arrivalTerminal) {
        const arrivalGateRow = qsid('arrivalGateRow');
        const arrivalGate = qsid('arrivalGate');
        const arrivalTerminal = qsid('arrivalTerminal');
        
        arrivalGateRow.style.display = 'flex';
        arrivalGate.textContent = statusData.arrivalGate || 'TBD';
        arrivalTerminal.textContent = statusData.arrivalTerminal ? `(${statusData.arrivalTerminal})` : '';
      }
      
      // Show baggage claim
      if (statusData.baggageClaim) {
        const baggageRow = qsid('baggageRow');
        const baggageClaim = qsid('baggageClaim');
        
        baggageRow.style.display = 'flex';
        baggageClaim.textContent = statusData.baggageClaim;
      }
      
      // Show delay info
      if (statusData.delay && statusData.delay > 0) {
        const delayRow = qsid('delayRow');
        const delayInfo = qsid('delayInfo');
        
        delayRow.style.display = 'flex';
        delayInfo.textContent = `${statusData.delay} minutes`;
      }
      
      // Update last updated time
      if (statusData.lastUpdated) {
        const updateTime = new Date(statusData.lastUpdated);
        const timeStr = updateTime.toLocaleTimeString();
        lastUpdated.textContent = `Last updated: ${timeStr}`;
      }
    }

    // Manual refresh function
    async function refreshFlightStatus() {
      const refreshButton = qsid('refreshButton');
      const lastUpdated = qsid('lastUpdated');
      
      // Disable button and show loading
      refreshButton.disabled = true;
      refreshButton.textContent = 'üîÑ Refreshing...';
      lastUpdated.textContent = 'Refreshing...';
      
      try {
        await loadFlightStatus();
      } catch (error) {
        console.error('Error refreshing flight status:', error);
        lastUpdated.textContent = 'Refresh failed';
      } finally {
        // Re-enable button
        refreshButton.disabled = false;
        refreshButton.textContent = 'üîÑ Refresh Status';
      }
    }

    // Check if date is in DST (same logic as calendar)
    function isDSTDate(date) {
      const jan = new Date(date.getFullYear(), 0, 1);
      const jul = new Date(date.getFullYear(), 6, 1);
      return date.getTimezoneOffset() < Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
    }

    // Display flight data
    function displayFlightData(data) {
      // Parse departure time range
      const [departureTime, arrivalTime] = data.departureTime.split('/');
      
      // Create dates from UTC timestamps (same as calendar)
      const depDate = new Date(departureTime);
      const arrDate = new Date(arrivalTime);
      
      // Add Pacific offset for floating times (exact same logic as calendar)
      const isDST = isDSTDate(depDate);
      const offsetHours = isDST ? 7 : 8;
      
      depDate.setHours(depDate.getHours() + offsetHours);
      arrDate.setHours(arrDate.getHours() + offsetHours);
      
      
      // Update airport codes and times
      qsid('depCode').textContent = data.departureCode;
      qsid('arrCode').textContent = data.arrivalCode;
      
      qsid('depActual').textContent = fmtTime(depDate);
      qsid('arrActual').textContent = fmtTime(arrDate);
      
      qsid('depDate').textContent = fmtDate(depDate);
      qsid('arrDate').textContent = fmtDate(arrDate);
      
      // Update meta info
      qsid('depMeta').innerHTML = `<b>Departure</b><br>${data.departureName}`;
      qsid('arrMeta').innerHTML = `<b>Arrival</b><br>${data.arrivalName}`;
      
      // Update footer
      qsid('totalDur').textContent = getFlightDuration(departureTime, arrivalTime);
      qsid('confirmation').textContent = data.confirmation;
      
      // Update status and progress
      updateStatusAndProgress(departureTime, arrivalTime);
    }

    // Update status banner and progress
    function updateStatusAndProgress(departureTime, arrivalTime) {
      const status = qsid('status');
      const statusBig = qsid('statusBig');
      const statusSub = qsid('statusSub');
      const plane = qsid('plane');
      const railLine = qsid('railLine');
      
      const now = new Date();
      const depDate = new Date(departureTime);
      const arrDate = new Date(arrivalTime);
      
      function fmtDur(ms) {
        const s = Math.max(0, Math.round(ms/1000));
        const d = s/86400|0;  // days
        const h = (s%86400)/3600|0;  // hours
        const m = (s%3600)/60|0;  // minutes
        
        if (d > 0) {
          return `${d}d ${h}h ${String(m).padStart(2,'0')}m`;
        } else if (h > 0) {
          return `${h}h ${String(m).padStart(2,'0')}m`;
        } else {
          return `${String(m).padStart(2,'0')}m`;
        }
      }
      
      function tick() {
        const now = new Date();
        
        if (now < depDate) {
          // Before departure
          status.className = 'status warn';
          statusBig.textContent = `Departs in ${fmtDur(depDate-now)}`;
          statusSub.textContent = 'Boarding soon';
          plane.style.top = '0px';
        } else if (now >= depDate && now <= arrDate) {
          // In flight
          status.className = 'status';
          statusBig.textContent = `Lands in ${fmtDur(arrDate-now)}`;
          statusSub.textContent = 'Flight is En Route';
          
          // Update plane position
          const t = (now - depDate) / (arrDate - depDate);
          const clamped = Math.max(0, Math.min(1, t));
          const h = railLine.getBoundingClientRect().height;
          plane.style.top = `${clamped * h}px`;
        } else {
          // After arrival
          status.className = 'status';
          statusBig.textContent = 'Landed';
          statusSub.textContent = `Arrived ${fmtDur(now-arrDate)} ago`;
          plane.style.top = '100%';
        }
      }
      
      setInterval(tick, 1000);
      tick();
    }

    // Show error message
    function showError(message) {
      const screen = document.querySelector('.screen');
      screen.innerHTML = `
        <div class="error">
          <div>
            <h3>Error</h3>
            <p>${message}</p>
            <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: var(--ok); color: white; border: none; border-radius: 4px; cursor: pointer;">
              Retry
            </button>
          </div>
        </div>
      `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadFlightData);
  </script>
</body>
</html>