<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Countdown</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flight Countdown">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="/Apple Logo.png">
    <link rel="manifest" href="/manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            color: #fff;
            padding: 20px;
            line-height: 1.4;
        }

        .flight-container {
            max-width: 400px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }

        .flight-header {
            padding: 30px 20px 20px 20px;
            background: #1a1a1a;
        }

        .flight-date {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .flight-route {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .flight-details-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .airline-logo {
            width: 24px;
            height: 24px;
            background: #dc2626;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .passenger-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .passenger-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #cccccc;
        }

        .passenger-name {
            font-size: 0.9rem;
            color: #999;
        }

        .status-bar {
            background: #2ecc71;
            margin: 0 20px 20px 20px;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
        }

        .status-main {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 6px;
        }

        .status-sub {
            font-size: 1rem;
            color: #ffffff;
            opacity: 0.95;
        }

        .flight-segments {
            background: #1a1a1a;
            margin: 0 20px;
        }

        .segment {
            padding: 24px 0;
            border-bottom: 1px solid #333;
        }

        .segment:last-child {
            border-bottom: none;
        }

        .segment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .segment-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2ecc71;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: white;
        }

        .segment-icon.departure::before {
            content: "↑";
        }

        .segment-icon.arrival::before {
            content: "↓";
        }

        .airport-code {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
        }

        .airport-name {
            font-size: 0.9rem;
            color: #999;
            margin-top: 2px;
        }

        .segment-details {
            font-size: 0.8rem;
            color: #999;
            margin-top: 4px;
        }

        .segment-time {
            text-align: right;
            flex: 1;
        }

        .time-main {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2ecc71;
        }

        .time-sub {
            font-size: 0.85rem;
            color: #999;
            margin-top: 2px;
        }

        .time-status {
            font-size: 0.75rem;
            color: #2ecc71;
            margin-top: 2px;
        }

        .flight-summary {
            text-align: center;
            padding: 16px 0;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            font-size: 0.85rem;
            color: #999;
            background: #1a1a1a;
            position: relative;
        }

        .error-message {
            background: #2d1b1b;
            border: 1px solid #dc2626;
            color: #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
        }

        @media (max-width: 480px) {
            .flight-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="flight-container">
        <div class="flight-header">
            <div class="flight-date" id="flight-date">Loading...</div>
            <div class="flight-route" id="flight-route">Loading route...</div>
            <div class="flight-details-header">
                <div class="airline-logo" id="airline-logo">DL</div>
                <div class="passenger-info">
                    <div class="passenger-avatar">D</div>
                    <div class="passenger-name">Diego</div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-main" id="status-main">Loading...</div>
            <div class="status-sub" id="status-sub">Flight Status</div>
        </div>

        <div class="flight-segments">
            <div class="segment">
                <div class="segment-header">
                    <div class="segment-icon departure"></div>
                    <div>
                        <div class="airport-code" id="departure-code">HNL</div>
                        <div class="airport-name" id="departure-name">Airport</div>
                        <div class="segment-details" id="departure-details"></div>
                    </div>
                    <div class="segment-time">
                        <div class="time-main" id="departure-time">1:14 PM</div>
                        <div class="time-status" id="departure-status">3h 27m ago</div>
                    </div>
                </div>
            </div>

            <div class="flight-summary">
                Total 5h 33m • 2,553 mi
            </div>

            <div class="segment">
                <div class="segment-header">
                    <div class="segment-icon arrival"></div>
                    <div>
                        <div class="airport-code" id="arrival-code">LAX</div>
                        <div class="airport-name" id="arrival-name">Airport</div>
                        <div class="segment-details" id="arrival-details"></div>
                    </div>
                    <div class="segment-time">
                        <div class="time-main" id="arrival-time">9:47 PM</div>
                        <div class="time-status" id="arrival-status">in 2h 6m</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Parse flight data from URL
        const flightNumber = getUrlParameter('flight') || 'N/A';
        const departureTimeStr = getUrlParameter('departure');
        const airline = getUrlParameter('airline') || 'N/A';
        const route = getUrlParameter('route') || 'N/A';
        const confirmation = getUrlParameter('confirmation') || 'N/A';
        const departureCode = getUrlParameter('departureCode') || 'N/A';
        const arrivalCode = getUrlParameter('arrivalCode') || 'N/A';
        const departureName = getUrlParameter('departureName') || 'N/A';
        const arrivalName = getUrlParameter('arrivalName') || 'N/A';
        
        console.log('URL:', window.location.href);
        console.log('Search params:', window.location.search);
        console.log('Departure time string:', departureTimeStr);

        // Validate required parameters - use test data if not available
        let finalDepartureTimeStr = departureTimeStr;
        let finalFlightNumber = flightNumber;
        let finalAirline = airline;
        let finalRoute = route;
        
        if (!finalDepartureTimeStr) {
            console.log('No URL parameters found, using test data');
            finalDepartureTimeStr = '2025-10-19T13:15:00.000Z/2025-10-19T21:47:00.000Z';
            finalFlightNumber = 'DL 915';
            finalAirline = 'Delta';
            finalRoute = 'HNL-LAX';
        }

        // Parse departure time range to get both departure and arrival times
        const [departureStr, arrivalStr] = finalDepartureTimeStr.split('/');
        const departureTime = new Date(departureStr);
        const arrivalTime = new Date(arrivalStr);
        
        if (isNaN(departureTime.getTime()) || isNaN(arrivalTime.getTime())) {
            document.querySelector('.flight-container').innerHTML = `
                <div class="error-message">
                    <h3>❌ Invalid Flight Time</h3>
                    <p>The departure time format is invalid.</p>
                    <p>Please check your calendar event.</p>
                </div>
            `;
            throw new Error('Invalid departure time format');
        }
        
        // Apply the same floating time conversion as the main calendar
        function isDSTDate(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            
            // DST starts second Sunday in March at 2 AM
            const marchFirst = new Date(year, 2, 1);
            const dstStart = new Date(year, 2, 1 + (7 - marchFirst.getDay() + 7) % 7 + 7);
            
            // DST ends first Sunday in November at 2 AM
            const novFirst = new Date(year, 10, 1);
            const dstEnd = new Date(year, 10, 1 + (7 - novFirst.getDay()) % 7);
            
            const checkDate = new Date(year, month, day);
            return checkDate >= dstStart && checkDate < dstEnd;
        }
        
        // Convert to floating time (same as main calendar)
        const isDST = isDSTDate(departureTime);
        const offsetHours = isDST ? 7 : 8; // PDT is UTC-7, PST is UTC-8
        departureTime.setHours(departureTime.getHours() + offsetHours);
        arrivalTime.setHours(arrivalTime.getHours() + offsetHours);

        // Update flight information immediately
        try {
            // Format date for header
            const dateFormatted = departureTime.toLocaleDateString('en-US', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            }).toUpperCase();
            
            document.getElementById('flight-date').textContent = `${dateFormatted} • ${finalFlightNumber}`;
            document.getElementById('flight-route').textContent = finalRoute.replace('-', ' to ');
            
            // Set airline logo
            const airlineCode = finalAirline.substring(0, 2).toUpperCase();
            document.getElementById('airline-logo').textContent = airlineCode;
        } catch (error) {
            console.error('Error updating flight info:', error);
        }
        
        // Update flight segments with real data
        try {
            // Use airport codes and names from URL parameters
            const finalDepartureCode = departureCode !== 'N/A' ? departureCode : 'LAX';
            const finalArrivalCode = arrivalCode !== 'N/A' ? arrivalCode : 'SFO';
            const finalDepartureName = departureName !== 'N/A' ? departureName : 'Los Angeles Intl.';
            const finalArrivalName = arrivalName !== 'N/A' ? arrivalName : 'San Francisco Intl.';
            
            // Set airport codes
            document.getElementById('departure-code').textContent = finalDepartureCode;
            document.getElementById('arrival-code').textContent = finalArrivalCode;
            
            // Update the route display with clean airport codes
            const cleanRoute = `${finalDepartureCode} to ${finalArrivalCode}`;
            document.getElementById('flight-route').textContent = cleanRoute;
            
            // Set airport names from URL parameters
            document.getElementById('departure-name').textContent = finalDepartureName;
            document.getElementById('arrival-name').textContent = finalArrivalName;
            
            // Format departure time (now using floating time)
            const departureTimeFormatted = departureTime.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('departure-time').textContent = departureTimeFormatted;
            
            // Format arrival time (now using actual arrival time from date range)
            const arrivalTimeFormatted = arrivalTime.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('arrival-time').textContent = arrivalTimeFormatted;
            
            // Calculate actual flight duration
            const durationMs = arrivalTime - departureTime;
            const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
            const durationMinutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            
            // Update flight summary with actual duration
            document.querySelector('.flight-summary').textContent = `Total ${durationHours}h ${durationMinutes}m • 2,553 mi`;
            
        } catch (error) {
            console.error('Error updating flight segments:', error);
        }

        function updateCountdown() {
            const now = new Date();
            const timeLeft = departureTime - now;
            const timeToArrival = arrivalTime - now;
            
            
            if (timeLeft <= 0) {
                // Flight has departed
                if (timeToArrival > 0) {
                    // Flight is en route
                    const hours = Math.floor(timeToArrival / (1000 * 60 * 60));
                    const minutes = Math.floor((timeToArrival % (1000 * 60 * 60)) / (1000 * 60));
                    
                    document.getElementById('status-main').textContent = `Lands in ${hours}h ${minutes}m`;
                    document.getElementById('status-sub').textContent = 'Flight is En Route';
                    
                    // Update arrival status
                    document.getElementById('arrival-status').textContent = `in ${hours}h ${minutes}m`;
                    document.getElementById('departure-status').textContent = 'Departed';
                } else {
                    // Flight has arrived
                    document.getElementById('status-main').textContent = 'Flight Arrived';
                    document.getElementById('status-sub').textContent = 'Welcome to Los Angeles';
                    document.getElementById('arrival-status').textContent = 'Arrived';
                    document.getElementById('departure-status').textContent = 'Departed';
                }
                return;
            }
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            
            // Update status based on time remaining
            if (timeLeft <= 2 * 60 * 60 * 1000) { // 2 hours or less
                document.getElementById('status-main').textContent = `Boards in ${hours}h ${minutes}m`;
                document.getElementById('status-sub').textContent = 'Boarding Soon';
            } else if (timeLeft <= 24 * 60 * 60 * 1000) { // 24 hours or less
                document.getElementById('status-main').textContent = `Departs in ${hours}h ${minutes}m`;
                document.getElementById('status-sub').textContent = 'Flight Tomorrow';
            } else {
                document.getElementById('status-main').textContent = `Departs in ${days}d ${hours}h`;
                document.getElementById('status-sub').textContent = 'Flight Upcoming';
            }
            
            // Update departure status
            document.getElementById('departure-status').textContent = `in ${days}d ${hours}h ${minutes}m`;
        }
        
        // Update immediately and then every second
        updateCountdown();
        setInterval(updateCountdown, 1000);
        
        // Update page title with countdown
        function updateTitle() {
            const now = new Date();
            const timeLeft = departureTime - now;
            
            if (timeLeft <= 0) {
                document.title = `${flightNumber} - Departed`;
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            
            document.title = `${flightNumber} - ${hours}h ${minutes}m`;
        }
        
        setInterval(updateTitle, 60000); // Update title every minute
        updateTitle();

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
